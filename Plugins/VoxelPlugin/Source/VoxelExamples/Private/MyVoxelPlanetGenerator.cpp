// Copyright 2020 Phyronnaz

#include "MyVoxelPlanetGenerator.h"
#include "FastNoise/VoxelFastNoise.inl"
#include "VoxelMaterialBuilder.h"
#include <string>
#include <algorithm>
#include <future>
int* UMyVoxelPlanetGenerator::StaticFormatedTopographyImageData = nullptr;
int* UMyVoxelPlanetGenerator::StaticFormatedBiomesImageData = nullptr;
bool UMyVoxelPlanetGenerator::dataPopulated = false;
int UMyVoxelPlanetGenerator::gsX;
int UMyVoxelPlanetGenerator::gsY;
int UMyVoxelPlanetGenerator::gbsX;
int UMyVoxelPlanetGenerator::gbsY;

constexpr double precomputed_sin[] = { 2.4492935982947064e-16,0.009999833334166696,0.019998666693332896,0.029995500202495265,0.03998933418663355,0.04997916927067751,0.05996400647944357,0.06994284733753152,0.07991469396917124,0.08987854919800939,0.09983341664682628,0.10977830083717272,0.11971220728891706,0.12963414261969236,0.13954311464423377,0.1494381324735963,0.15931820661424284,0.16918234906699267,0.17902957342582065,0.18885889497649683,0.19866933079505728,0.20845989984609542,0.218229623080865,0.22797752353518386,0.23770262642712986,0.247403959254518,0.25708055189214996,0.2667314366888258,0.2763556485641082,0.28595222510482987,0.2955202066613337,0.30505863644343745,0.31456656061611155,0.32404302839486193,0.3334870921408078,0.34289780745544457,0.352274233275083,0.3616154319649548,0.3709204694129754,0.380188415123154,0.38941834230864286,0.3986093279844151,0.4077604530595622,0.41687080242920266,0.42593946506599134,0.4349655341112218,0.4439481069655112,0.45288628537905956,0.461779175541474,0.47062588817114903,0.47942553860419385,0.4881772468828982,0.4968801378437273,0.5055333412048374,0.5141359916531034,0.5226872289306493,0.5311861979208735,0.5396320487339592,0.5480239367918635,0.5563610229127736,0.564642473395025,0.5728674601004708,0.5810351605372945,0.5891447579422588,0.5971954413623813,0.6051864057360288,0.6131168519734229,0.6209859870365487,0.6287930240184574,0.6365371822219568,0.6442176872376798,0.6518337710215254,0.6593846719714618,0.6668696350036865,0.6742879116281336,0.6816387600233227,0.6889214451105398,0.6961352386273452,0.7032794192003985,0.7103532724175962,0.717356090899511,0.7242871743701308,0.7311458297268841,0.737931371109951,0.7446431199708475,0.7512804051402809,0.7578425628952652,0.7643289370254933,0.7707388788989575,0.7770717475268121,0.7833269096274716,0.7895037396899387,0.7956016200363543,0.8016199408837654,0.8075581004051026,0.8134155047893621,0.8191915683009867,0.8248857133384385,0.8304973704919589,0.8360259786005091,0.8414709848078851,0.8468318446180039,0.8521080219493516,0.8572989891885922,0.8624042272433273,0.8674232255940059,0.8723554823449753,0.8772005042746708,0.8819578068849367,0.8866269144494766,0.8912073600614248,0.8956986856800372,0.9001004421764948,0.9044121893788157,0.9086334961158732,0.9127639402605111,0.9168031087717572,0.920750597736126,0.9246060124080109,0.9283689672491574,0.9320390859672172,0.9356160015533769,0.9390993563190587,0.9424888019316888,0.9457839994495305,0.9489846193555779,0.9520903415905076,0.9551008555846843,0.9580158602892173,0.9608350642060651,0.9635581854171856,0.9661849516127269,0.9687151001182583,0.9711483779210378,0.9734845416953128,0.9757233578266529,0.9778646024353101,0.9799080613986084,0.9818535303723542,0.9837008148112713,0.9854497299884551,0.9871001010138456,0.9886517628517153,0.9901045603371735,0.9914583481916824,0.9927129910375848,0.9938683634116414,0.9949243497775778,0.9958808445376373,0.9967377520431409,0.9974949866040522,0.9981524724975461,0.9987101439755813,0.9991679452714747,0.9995258306054781,0.9997837641893563,0.999941720229966,0.9999996829318346,0.9999576464987404,0.9998156151342915,0.9995736030415061,0.9992316344213918,0.9987897434705257,0.9982479743776345,0.9976063813191761,0.9968650284539217,0.9960239899165398,0.9950833498101836,0.9940432021980798,0.9929036510941228,0.9916648104524732,0.990326804156163,0.9888897660047069,0.9873538397007222,0.9857191788355597,0.9839859468739435,0.9821543171376255,0.9802244727880529,0.9781966068080525,0.9760709219825324,0.9738476308782038,0.9715269558223244,0.9691091288804659,0.9665943918333075,0.9639829961524585,0.9612752029753108,0.9584712830789254,0.9555715168529556,0.9525761942716074,0.949485614864643,0.9463000876874275,0.943019931290024,0.9396454736853388,0.9361770523163204,0.9326150140222154,0.9289597150038846,0.925211520788184,0.9213708061914117,0.9174379552818266,0.9134133613412424,0.9092974268256994,0.9050905633252191,0.9007931915226459,0.896405741151579,0.8919286509533992,0.8873623686333955,0.8827073508159946,0.8779640629990991,0.873132979507538,0.8682145834456345,0.8632093666488962,0.8581178296348319,0.8529404815528997,0.8476778401335937,0.8423304316366702,0.8368987907985227,0.8313834607787086,0.825784993105634,0.8201039476214007,0.8143408924258229,0.8084964038196176,0.8025710662467752,0.7965654722361151,0.7904802223420337,0.7843159250844495,0.7780731968879512,0.7717526620201564,0.7653549525292845,0.7588807081809534,0.7523305763942028,0.7457052121767527,0.7390052780595039,0.7322314440302848,0.7253843874668536,0.7184647930691607,0.7114733527908794,0.7044107657702117,0.6972777382599739,0.6900749835569728,0.6828032219306768,0.6754631805511885,0.6680555934165291,0.6605812012792392,0.6530407515723039,0.6454349983344102,0.6377647021345438,0.6300306299959327,0.6222335553193459,0.6143742578057532,0.6064535233783569,0.598472144103999,0.5904309181139558,0.5823306495241254,0.5741721483546164,0.5659562304487472,0.5576837173914617,0.5493554364271721,0.5409722203770343,0.5325349075556676,0.5240443416873228,0.5155013718215116,0.5069068522481011,0.49826164241188686,0.4895666068266481,0.4808226149886975,0.47203054128993216,0.4631912649303953,0.45430566983035686,0.4453746445419222,0.43639908216017764,0.42737988023388174,0.41831794067571115,0.4092141696720702,0.40006947759247263,0.3908847788985059,0.38166099205238563,0.3723990394251099,0.3630998472042231,0.3537643453011981,0.34439346725844566,0.33498815015596095,0.3255493345176165,0.3160779642171105,0.30657498638358016,0.29704135130688986,0.28747801234260245,0.277885925816645,0.2682660509296767,0.2586193496611698,0.24894678667321213,0.2392493292140421,0.22952794702132448,0.21978361222517737,0.21001729925096013,0.20022998472183162,0.19042264736108871,0.1805962678942947,0.17075182895120766,0.1608903149675182,0.15101271208640682,0.1411200080599303,0.13121319215024738,0.12129325503069342,0.11136118868671377,0.10141798631666613,0.09146464223250152,0.08150215176033394,0.07153151114090857,0.061553717429978505,0.05156976839860003,0.041580662433356355,0.03158739843651979,0.021590975726162313,0.011592393936224639,0.0015926529165536407,-0.008407247367081807,-0.018406306932986564,-0.02840352588353656,-0.038397904505167724,-0.04838844336834652,-0.05837414342751206,-0.06835400612097979,-0.07832703347079692,-0.08829222818253928,-0.09824859374503998,-0.10819513453003975,-0.11813085589174882,-0.12805476426631077,-0.13796586727115803,-0.14786317380424935,-0.15774569414317915,-0.16761244004414896,-0.1774624248407909,-0.1872946635428336,-0.19710817293460042,-0.20690197167333005,-0.21667508038731007,-0.2264265217738133,-0.23615532069682732,-0.2458605042845671,-0.2555411020267615,-0.2651961458717034,-0.2748246703230542,-0.2844257125363925,-0.2939983124154978,-0.30354151270835933,-0.3130543591029004,-0.32253590032240903,-0.33198518822066436,-0.34140127787675106,-0.3507832276895502,-0.3601300994718988,-0.36944095854440756,-0.3787148738289284,-0.387950917941661,-0.39714816728589075,-0.40630570214434764,-0.41542260677117704,-0.42449796948351365,-0.4335308827526491,-0.4425204432947838,-0.4514657521613548,-0.4603659148289299,-0.4692200412886591,-0.4780272461352748,-0.4867866486556317,-0.49549737291677726,-0.5041585478535442,-0.5127693073556565,-0.5213287903543397,-0.5298361409084266,-0.5382905082899512,-0.5466910470692208,-0.5550369171993579,-0.5633272841003042,-0.5715613187422783,-0.5797381977286779,-0.5878571033784179,-0.5959172238076995,-0.6039177530111963,-0.6118578909426552,-0.6197368435948997,-0.6275538230792302,-0.6353080477042128,-0.6429987420538464,-0.6506251370651052,-0.6581864701048432,-0.6656819850460577,-0.6731109323435007,-0.6804725691086333,-0.6877661591839136,-0.6949909732164121,-0.7021462887307461,-0.7092313902013271,-0.7162455691239121,-0.723188124086454,-0.730058360839242,-0.7368555923643261,-0.743579138944218,-0.7502283282298627,-0.7568024953078727,-0.7633009827670184,-0.7697231407639695,-0.7760683270882781,-0.7823359072265993,-0.7885252544261422,-0.7946357497573446,-0.8006667821757657,-0.8066177485831892,-0.8124880538879337,-0.8182771110643604,-0.823984341211576,-0.8296091736113219,-0.8351510457850453,-0.840609403550147,-0.8459837010753992,-0.8512734009355281,-0.8564779741649554,-0.8615969003106956,-0.8666296674843996,-0.8715757724135442,-0.8764347204917583,-0.881206025828283,-0.8858892112965607,-0.8904838085819474,-0.8949893582285432,-0.8994054096851382,-0.9037315213502667,-0.9079672606163671,-0.9121122039130429,-0.9161659367494184,-0.9201280537555879,-0.9239981587231527,-0.9277758646448412,-0.931460793753209,-0.9350525775584164,-0.9385508568850758,-0.9419552819081697,-0.945265512188033,-0.9484812167043961,-0.9516020738894873,-0.9546277716601884,-0.9575580074492441,-0.9603924882355171,-0.9631309305732911,-0.9657730606206142,-0.9683186141666834,-0.9707673366582655,-0.9731189832251518,-0.9753733187046454,-0.9775301176650769,-0.9795891644283476,-0.9815502530914971,-0.9834131875472932,-0.9851777815038429,-0.986843858503221,-0.9884112519391158,-0.98987980507349,-0.9912493710522541,-0.9925198129199512,-0.9936910036334535,-0.9947628260746655,-0.9957351730622362,-0.9966079473622774,-0.9973810616980862,-0.9980544387588732,-0.9986280112074937,-0.9991017216871806,-0.9994755228272808,-0.9997493772479917,-0.9999232575640996,-0.9999971463877178,-0.9999710363300253,-0.9998449300020061,-0.9996188400141882,-0.9992927889753818,-0.998866809490419,-0.9983409441568935,-0.9977152455609002,-0.9969897762717774,-0.9961646088358496,-0.9952398257691726,-0.9942155195492824,-0.9930917926059475,-0.9918687573109257,-0.9905465359667274,-0.989125260794385,-0.9876050739202316,-0.9859861273616876,-0.9842685830120599,-0.9824526126243519,-0.9805383977940894,-0.9785261299411601,-0.9764160102906724,-0.9742082498528328,-0.9719030694018456,-0.9695006994538347,-0.9670013802437929,-0.9644053617015586,-0.9617129034268226,-0.9589242746631687,-0.9560397542711493,-0.9530596307003999,-0.9499842019607943,-0.9468137755926433,-0.9435486686359421,-0.9401892075986652,-0.9367357284241168,-0.9331885764573364,-0.929548106410565,-0.9258146823277733,-0.9219886775482585,-0.9180704746693102,-0.9140604655079512,-0.9099590510617559,-0.9057666414687511,-0.9014836559664023,-0.897110522849691,-0.8926476794282842,-0.8880955719828052,-0.8834546557202051,-0.8787253947282427,-0.8739082619290762,-0.8690037390319714,-0.8640123164851305,-0.8589344934266492,-0.8537707776346015,-0.8485216854762636,-0.8431877418564772,-0.8377694801651593,-0.8322674422239636,-0.8266821782320996,-0.8210142467113118,-0.8152642144500292,-0.8094326564466862,-0.8035201558522234,-0.7975273039117733,-0.7914546999055359,-0.7853029510888513,-0.7790726726314748,-0.7727644875560603,-0.7663790266758583,-0.759916928531636,-0.7533788393278223,-0.7467654128678896,-0.7400773104889724,-0.7333152009957354,-0.7264797605934928,-0.7195716728205888,-0.7125916284800435,-0.7055403255704749,-0.6984184692162974,-0.6912267715972117,-0.6839659518769866,-0.6766367361315436,-0.6692398572763496,-0.661776054993126,-0.6542460756558812,-0.646650672256274,-0.6389906043283151,-0.6312666378724137,-0.6234795452787788,-0.6156301052501807,-0.6077191027240808,-0.5997473287941395,-0.5917155806311065,-0.5836246614031051,-0.5754753801953157,-0.567268551929068,-0.5590049972803495,-0.5506855425977389,-0.5423110198197718,-0.533882266391747,-0.5254001251819833,-0.5168654443975335,-0.5082790774993636,-0.4996418831170084,-0.4909547249627083,-0.4822184717450395,-0.4734339970820436,-0.46460217941386645,-0.4557239019149152,-0.44680005240554105,-0.43783152326325847,-0.428819211333508,-0.4197640178399723,-0.4106668482944548,-0.4015286124063291,-0.3923502239915688,-0.3831326008813668,-0.37387666483035276,-0.36458334142441856,-0.35525355998816033,-0.34588825349194696,-0.3364883584586236,-0.32705481486986043,-0.3175885660721551,-0.30809055868249874,-0.2985617424937154,-0.28900307037948336,-0.27941549819904843,-0.2697999847016391,-0.26015749143059214,-0.2504889826271994,-0.24079542513428395,-0.2310777882995173,-0.22133704387848488,-0.21157416593751155,-0.20179013075625565,-0.19198591673008206,-0.18216250427222316,-0.17232087571573862,-0.16246201521528275,-0.15258690864868993,-0.1426965435183876,-0.13279190885264677,-0.12287399510668026,-0.11294379406359772,-0.10300229873522836,-0.09305050326282042,-0.08308940281762804,-0.07311999350139482,-0.0631432722467446,-0.05316023671748892,-0.04317188520886154,-0.033179216547689724,-0.023183229992512395,-0.01318492513365511,-0.00318530179327186,0.006814640074636309,0.01681390048421586,0.02681147951775853,0.03680637742569225,0.04679759472655527,0.05678413230694351,0.06676499152142101,0.07673917429238367,0.0867056832098662,0.09666352163128222,0.1066116937810878,0.11654920485035804,0.12647506109626727,0.1363882699414624,0.14628784007331988,0.15617278154307618,0.1660421058648217,0.17589482611434873,0.18572995702784284,0.1955465151004086,0.20534351868441925,0.21511998808768046,0.22487494567139896,0.23460741594794549,0.24431642567840275,0.2540010039698885,0.2636601823726441,0.2732929949768785,0.2828984785093586,0.2924756724297357,0.3020236190265988,0.31154136351324474,0.32102795412315627,0.33048244220517786,0.3399038823183801,0.3492913323266028,0.358643853492668,0.3679605105722527,0.377240371907413,0.3864825095197485,0.3956859992031997,0.4048499206164678,0.4139733573750481,0.4230553971428675,0.4320951317235176,0.44109165715107346,0.45004407378048933,0.45895148637756267,0.46781300420845656,0.47662774112877243,0.4853948156721639,0.49411335113848254,0.502782475681447,0.5114013223958274,0.5199690294041345,0.5284847399428073,0.5369476024478883,0.5453567706401794,0.5537114036098689,0.562010665900622,0.5702537275931258,0.5784397643880801,0.5865679576886271,0.5946374946822103,0.6026475684218549,0.6105973779068619,0.6184861281629076,0.6263130303215404,0.634077301699067,0.6417781658748195,0.649414852768798,0.6569865987186768,0.6644926465561708,0.6719322456827511,0.6793046521447049,0.6866091287075295,0.6938449449296558,0.7010113772354912,0.7081077089877774,0.7151332305592525,0.7220872394036142,0.7289690401257727,0.7357779445513909,0.7425132717957003,0.7491743483315889,0.7557605080569544,0.7622710923613125,0.7687054501916583,0.7750629381175707,0.7813429203955548,0.7875447690326164,0.7936678638490599,0.799711592540506,0.8056753507391223,0.8115585420740586,0.817360578231084,0.8230808790114178,0.828718872389749,0.8342739945714379,0.8397456900488957,0.8451334116571343,0.8504366206284828,0.8556547866464632,0.8607873878988223,0.8658339111297119,0.8707938516910143,0.8756667135928069,0.88045200955296,0.8851492610458653,0.889757998350288,0.8942777605963381,0.8987080958115578,0.903048560966117,0.9072987220171177,0.9114581539519964,0.9155264408310257,0.9195031758289083,0.923387961275458,0.9271804086953676,0.9308801388470553,0.9344867817605892,0.9379999767746835,0.9414193725727644,0.9447446272181015,0.9479754081880014,0.9511113924070593,0.9541522662794668,0.9570977257203706,0.959947476186281,0.9627012327045263,0.9653587199017497,0.9679196720314458,0.9703838330005358,0.9727509563949762,0.9750208055044002,0.9771931533457884,0.979267782686167,0.9812444860643307,0.9831230658115889,0.9849033340715325,0.9865851128188191,0.9881682338769753,0.9896525389352144,0.9910378795642679,0.992324117231227,0.9935111233133971,0.994598779111159,0.9955869758598394,0.9964756147405868,0.9972646068902536,0.9979538734102826,0.998543345374596,0.9990329638364887,0.9994226798345223,0.999712454397422,0.9999022585479729,0.9999920733059181,0.9999818896898566,0.9998717087181417,0.9996615414087785,0.9993514087783231,0.9989413418397798,0.9984313815995008,0.9978215790530854,0.9971119951802799,0.9963027009388802,0.9953937772576361,0.9943853150281583,0.9932774150958295,0.9920701882497193,0.9907637552115066,0.9893582466234065,0.9878538030351066,0.9862505748897119,0.984548722508701,0.9827484160758936,0.980849835620433,0.9788531709987826,0.9767586218757405,0.9745663977044736,0.9722767177055722,0.9698898108451283,0.9674059158118385,0.9648252809931366,0.9621481644503537,0.9593748338929132,0.9565055666515598,0.9535406496506266,0.9504803793793429,0.9473250618621856,0.944075012628277,0.9407305566798321,0.9372920284596588,0.9337597718177135,0.9301341399767171,0.9264154954968322,0.922604210239408,0.9187006653297941,0.9147052511192286,0.9106183671458029,0.9064404220945089,0.9021718337563699,0.8978130289866626,0.8933644436622316,0.8888265226379023,0.8841997197019956,0.8794844975309493,0.8746813276430512,0.8697906903512874,0.8648130747153118,0.8597489784925397,0.8545989080883736,0.8493633785055619,0.8440429132927001,0.8386380444918758,0.8331493125854651,0.8275772664420846,0.8219224632617053,0.8161854685199329,0.8103668559114608,0.8044672072927012,0.7984871126235992,0.7924271699086387,0.786287985137041,0.7800701722221675,0.7737743529401281,0.7674011568676045,0.7609512213188929,0.7544251912821733,0.7478237193550111,0.7411474656790978,0.7343970978742373,0.7275732909715851,0.7206767273461447,0.7137080966485316,0.7066680957360085,0.6995574286027999,0.6923768063096936,0.685126946912935,0.6778085753924223,0.6704224235792091,0.6629692300823214,0.6554497402148981,0.6478647059196595,0.6402148856937143,0.6325010445127105,0.6247239537543379,0.6168843911211913,0.6089831405630013,0.6010209921982392,0.5929987422351065,0.5849171928919142,0.5767771523168621,0.5685794345072244,0.5603248592279505,0.5520142519296897,0.5436484436662462,0.535228271011475,0.5267545759756247,0.5182282059211376,0.5096500134779137,0.501020856458049,0.49234159777005443,0.48361310533256613,0.4748362519875542,0.4660119154130391,0.4571409780353246,0.4482243269407562,0.4392628537870127,0.43025745471394167,0.4212090302539459,0.4121184852419311,0.4029867287248231,0.3938146738706637,0.3846032378772951,0.37535334188064035,0.366065910862591,0.3567418735585092,0.34738216236435554,0.3379877132434496,0.3285594656328748,0.31909836234953537,0.30960534949587537,0.30008137636526944,0.29052739534709393,0.2809443618314891,0.27133323411382054,0.26169497329885094,0.2520305432046299,0.24234091026611312,0.2326270434385198,0.2228899141004379,0.2131304959566869,0.2033497649409484,0.19354869911817338,0.18372827858677657,0.17388948538062748,0.16403330337084776,0.1541607181674249,0.14427271702065214,0.1343702887224042,0.12445442350725887,0.11452611295347448,0.10458634988383286,0.09463612826635787,0.08467644311491941,0.07470829038973294,0.06473266689776418,0.05475057019304936,0.04476299847694056,0.03477095049828644,0.024775425453558188,0.014777422886930697,0.004777942590328993,-0.0052220154965501395,-0.015221451386231282,-0.0252193651434583,-0.03521475698518704,-0.0452066273805628,-0.05519397715087256,-0.06517580756946206,-0.07515112046160762,-0.08511891830433274,-0.09507820432615961,-0.10502798260678545,-0.11496725817667364,-0.12489503711654988,-0.13481032665679332,-0.14471213527671264,-0.15459947280369735,-0.16447135051223416,-0.17432678122277873,-0.18416477940047285,-0.19398436125369709,-0.20378454483244904,-0.21356435012653763,-0.22332279916358327,-0.23305891610681426,-0.24277172735264968,-0.25246026162805896,-0.2621235500876883,-0.2717606264107444,-0.2813705268976258,-0.2909522905662922,-0.30050495924836135,-0.31002757768492567,-0.3195191936220769,-0.3289788579061311,-0.3384056245785428,-0.3477985509705004,-0.35715669779719206,-0.3664791292517336,-0.37576491309874827,-0.3850131207675894,-0.394222827445197,-0.40339311216857804,-0.41252305791690197,-0.4216117517032023,-0.4306582846656743,-0.4396617521585604,-0.44862125384261425,-0.4575358937751336,-0.46640478049955414,-0.475227027134594,-0.48400175146294167,-0.4927280760194765,-0.5014051281790147,-0.5100320402435712,-0.5186079495291287,-0.5271319984519051,-0.5356033346141115,-0.5440211108891911,-0.5523844855065313,-0.5606926221356396,-0.5689446899697768,-0.5771398638090358,-0.5852773241428623,-0.593356257232004,-0.6013758551898843,-0.6093353160633906,-0.6172338439130683,-0.6250706488927145,-0.6328449473283619,-0.6405559617966455,-0.6482029212025443,-0.6557850608564901,-0.663301622550836,-0.6707518546356763,-0.6781350120940112,-0.6854503566162472,-0.6926971566740283,-0.6998746875933878,-0.7069822316272147,-0.714019078027029,-0.7209845231140545,-0.727877870349587,-0.7346984304046473,-0.7414455212289139,-0.7481184681189269,-0.7547166037855578,-0.7612392684207387,-0.7676858097634415,-0.7740555831649039,-0.780347951653094,-0.7865622859964065,-0.7926979647665859,-0.798754374400868,-0.8047309092633365,-0.8106269717054855,-0.8164419721259841,-0.8221753290296363,-0.8278264690855293,-0.8333948271843667,-0.8388798464949793,-0.8442809785200064,-0.8495976831507467,-0.8548294287211677,-0.859975692061072,-0.8650359585484143,-0.8700097221607626,-0.8748964855259005,-0.8796957599715638,-0.8844070655743073,-0.8890299312074968,-0.8935638945884213,-0.8980085023245212,-0.9023633099587265,-0.9066278820139029,-0.9108017920363985,-0.9148846226386895,-0.9188759655411181,-0.9227754216127197,-0.9265826009111372,-0.9302971227216131,-0.933918615595062,-0.9374467173852142,-0.9408810752848309,-0.944221345860984,-0.9474671950893996,-0.9506182983878596,-0.9536743406486601,-0.9566350162701217,-0.9595000291871495,-0.9622690929008393,-0.9649419305071272,-0.9675182747244799,-0.9699978679206228,-0.9723804621383025,-0.9746658191200828,-0.9768537103321698,-0.9789439169872657,-0.9809362300664467,-0.9828304503400652,-0.9846263883876724,-0.9863238646169601,-0.9879227092817198,-0.9894227624988176,-0.9908238742641817,-0.9921259044678032,-0.9933287229077469,-0.9944322093031708,-0.9954362533063552,-0.9963407545137365,-0.9971456224759475,-0.9978507767068628,-0.9984561466916472,-0.9989616718938062,-0.9993673017612412,-0.9996729957313034,-0.9998787232348505,-0.9999844636993037,-0.9999902065507045,-0.9998959512147726,-0.9997017071169632,-0.9994074936815239,-0.9990133403295535,-0.9985192864760583,-0.9979253815260122,-0.9972316848694152,-0.9964382658753549,-0.9955452038850694,-0.9945525882040138,-0.9934605180929288,-0.9922691027579156,-0.9909784613395146,-0.9895887229007925,-0.9881000264144347,-0.9865125207488494,-0.9848263646532803,-0.9830417267419318,-0.9811587854771078,-0.9791777291513656,-0.9770987558686871,-0.974922073524668,-0.9726478997857286,-0.9702764620673481,-0.9678079975113217,-0.9652427529620482,-0.9625809849418449,-0.9598229596252954,-0.9569689528126333,-0.9540192499021614,-0.9509741458617126,-0.9478339451991534,-0.9445989619319334,-0.9412695195556833,-0.9378459510118664,-0.9343285986544839,-0.9307178142158405,-0.9270139587713713,-0.9232174027035338,-0.9193285256647713,-0.9153477165395469,-0.9112753734054558,-0.9071119034934177,-0.9028577231469544,-0.8985132577805554,-0.8940789418371368,-0.8895552187445978,-0.8849425408714778,-0.8802413694817204,-0.8754521746885469,-0.8705754354074455,-0.8656116393082806,-0.8605612827665254,-0.8554248708136256,-0.8502029170864961,-0.8448959437761581,-0.83950448157552,-0.8340290696263092,-0.8284702554651575,-0.822828594968849,-0.8171046522987319,-0.811298999844303,-0.8054122181659701,-0.7994448959369951,-0.7933976298846283,-0.7872710247304355,-0.7810656931298268,-0.7747822556107908,-0.7684213405118436,-0.7619835839191942,-0.755469629603137,-0.7488801289536755,-0.7422157409153833,-0.7354771319215107,-0.7286649758273414,-0.7217799538428082,-0.714822754464372,-0.7077940734061731,-0.7006946135304599,-0.6935250847773039,-0.6862862040936059,-0.6789786953614017,-0.6716032893254751,-0.6641607235202835,-0.6566517421962054,-0.6490770962451154,-0.6414375431252969,-0.6337338467856953,-0.6259667775895249,-0.6181371122372328,-0.6102456336888296,-0.6022931310855937,-0.5942803996711585,-0.5862082407119884,-0.5780774614172521,-0.5698888748581039,-0.5616432998863756,-0.5533415610526933,-0.544984488524022,-0.5365729180006507,-0.5281076906326218,-0.5195896529356179,-0.5110196567063104,-0.5023985589371807,-0.49372722173082123,-0.4850065122137267,-0.4762373024495815,-0.4674204693520545,-0.458556894597108,-0.4496474645348313,-0.4406930701008061,-0.4316946067270138,-0.4226529742522931,-0.41356907683235683,-0.4044438228493771,-0.39527812482114777,-0.3860728993098337,-0.376829066830315,-0.3675475517581364,-0.3582292822370706,-0.3488751900863046,-0.3394862107072582,-0.33006328299004534,-0.32060734921958534,-0.3111193549813753,-0.3016002490669323,-0.2920509833789154,-0.28247251283593555,-0.2728657952770651,-0.26323179136605435,-0.25357146449526613,-0.2438857806893372,-0.2341757085085768,-0.22444221895211133,-0.2146862853607852,-0.20490888331982765,-0.19511099056129494,-0.18529358686629807,-0.17545765396702537,-0.16560417544857017,-0.15573413665057317,-0.1458485245686891,-0.1359483277558882,-0.1260345362236016,-0.1161081413427211,-0.10617013574446277,-0.09622151322110481,-0.08626326862660907,-0.07629639777713648,-0.0663218973514663,-0.05634076479132905,-0.046353998201663145,-0.03636259625080527,-0.026367558070624377,-0.016369883156609314,-0.006370571267920115 };
constexpr double precomputed_cos[] = { 1.0, 0.9999500004166653, 0.9998000066665778, 0.9995500337489875, 0.9992001066609779, 0.9987502603949663, 0.9982005399352042, 0.9975510002532797, 0.9968017063026196, 0.9959527330119944, 0.9950041652780259, 0.993956097956697, 0.9928086358538666, 0.9915618937147883, 0.9902159962126376, 0.9887710779360427, 0.9872272833756275, 0.9855847669095613, 0.983843692788122, 0.9820042351172711, 0.9800665778412424, 0.9780309147241492, 0.9758974493306064, 0.9736663950053759, 0.9713379748520308, 0.9689124217106461, 0.9663899781345145, 0.963770896365892, 0.9610554383107726, 0.9582438755126989, 0.9553364891256079, 0.9523335698857154, 0.9492354180824429, 0.9460423435283891, 0.9427546655283485, 0.9393727128473814, 0.9358968236779375, 0.9323273456060371, 0.9286646355765131, 0.9249090598573161, 0.9210609940028883, 0.9171208228166084, 0.9130889403123118, 0.9089657496748889, 0.9047516632199673, 0.900447102352681, 0.8960524975255295, 0.8915682881953334, 0.8869949227792888, 0.8823328586101263, 0.8775825618903778, 0.8727445076457565, 0.8678191796776553, 0.8628070705147666, 0.8577086813638299, 0.8525245220595118, 0.8472551110134223, 0.8419009751622751, 0.8364626499151936, 0.8309406791001703, 0.8253356149096853, 0.8196480178454868, 0.8138784566625414, 0.8080275083121596, 0.8020957578843007, 0.7960837985490641, 0.7899922314973735, 0.783821665880858, 0.7775727187509369, 0.7712460149971159, 0.7648421872844979, 0.7583618759905179, 0.7518057291409049, 0.7451744023448806, 0.7384685587295984, 0.7316888688738317, 0.7248360107409162, 0.7179106696109546, 0.7109135380122888, 0.7038453156522478, 0.6967067093471775, 0.6894984329517593, 0.6822212072876261, 0.67487576007128, 0.6674628258413212, 0.6599831458849956, 0.6524374681640656, 0.6448265472400152, 0.6371511441985944, 0.6294120265737114, 0.6216099682706793, 0.6137457494888267, 0.6058201566434782, 0.5978339822873139, 0.5897880250311142, 0.5816830894638998, 0.5735199860724732, 0.5652995311603711, 0.5570225467662344, 0.548689860581605, 0.5403023058681574, 0.5318607213743735, 0.5233659512516678, 0.514818844969974, 0.5062202572327973, 0.49757104789174617, 0.48887208186054704, 0.4801242290285539, 0.4713283641737601, 0.46248536687532127, 0.4535961214255981, 0.4446615167417278, 0.4356824462767334, 0.4266598079301789, 0.41759450395837994, 0.40848744088417943, 0.3993395294062956, 0.390151684308253, 0.3809248243669048, 0.37165987226055625, 0.3623577544766972, 0.35301940121935427, 0.3436457463160712, 0.3342377271245271, 0.324796284438801, 0.3153223623952937, 0.30581690837831466, 0.29628087292534433, 0.28671520963198144, 0.27712087505658384, 0.2674988286246139, 0.2578500325326964, 0.2481754516524, 0.2384760534337505, 0.22875280780848703, 0.21900668709306942, 0.20923866589144746, 0.19944972099760133, 0.189640831297863, 0.1798129776730284, 0.1699671429002701, 0.16010431155486063, 0.15022546991171545, 0.1403316058467666, 0.1304237087381757, 0.12050276936739701, 0.11056977982010024, 0.10062573338696264, 0.09067162446434084, 0.08070844845483204, 0.07073720166773456, 0.06075888121941779, 0.05077448493361131, 0.0407850112416234, 0.030791459082498723, 0.020794827803125263, 0.010796117058300452, 0.0007963267107665472, -0.009203543268774832, -0.019202492901658926, -0.02919952230125488, -0.03919363177295356, -0.0491838219141362, -0.0591690937141138, -0.06914844865402742, -0.07912088880669914, -0.08908541693642404, -0.0990410365986929, -0.10898675223983582, -0.11892156929657674, -0.128844494295489, -0.13875453495234175, -0.14865070027132765, -0.1585320006441616, -0.16839744794904069, -0.17824605564945561, -0.1880768388928435, -0.19788881460907226, -0.20768100160874692, -0.2174524206813276, -0.22720209469304992, -0.23692904868463738, -0.2466323099687966, -0.2563109082274852, -0.2659638756089427, -0.2755902468244752, -0.285189059244983, -0.29475935299722306, -0.30430017105979534, -0.31381055935884433, -0.3232895668634653, -0.33273624568080706, -0.34214965115086, -0.3515288419409216, -0.36087288013972885, -0.3701808313512485, -0.3794517647881161, -0.3886847533647136, -0.39787887378987746, -0.40703320665922704, -0.4161468365471038, -0.42521885209811383, -0.43424834611826185, -0.4432344156656705, -0.45217616214087336, -0.46107269137667434, -0.4699231137275636, -0.47872654415868143, -0.4874821023343208, -0.49618891270596055, -0.504846104599819, -0.5134528123039213, -0.5220081751546689, -0.5305113376229066, -0.5389614493994732, -0.5473576654802329, -0.5556991462505745, -0.5639850575693721, -0.5722145708523988, -0.5803868631551841, -0.588501117255308, -0.5965565217341223, -0.604552271057892, -0.6124875656583478, -0.6203616120126424, -0.6281736227227019, -0.6359228165939655, -0.6436084187135037, -0.651229660527509, -0.6587857799181511, -0.6662760212797878, -0.6736996355945246, -0.6810558805071165, -0.6883440203992024, -0.6955633264628664, -0.7027130767735184, -0.7097925563620853, -0.7168010572865078, -0.7237378787025338, -0.7306023269338026, -0.7373937155412111, -0.7441113653915583, -0.7507546047254571, -0.75732276922451, -0.7638152020777407, -0.7702312540472742, -0.7765702835332602, -0.7828316566380327, -0.7890147472294988, -0.7951189370037521, -0.8011436155469019, -0.8070881803961146, -0.8129520370998589, -0.8187345992773509, -0.8244352886771917, -0.830053535235192, -0.8355887771313778, -0.841040460846172, -0.8464080412157464, -0.8516909814865369, -0.8568887533689188, -0.8620008370900354, -0.8670267214457746, -0.8719659038518892, -0.8768178903942545, -0.8815821958782594, -0.8862583438773258, -0.8908458667805508, -0.8953443058394667, -0.8997532112139164, -0.9040721420170367, -0.9083006663593461, -0.9124383613919343, -0.9164848133487461, -0.9204396175879579, -0.9243023786324412, -0.9280727102093108, -0.9317502352885508, -0.935334586120718, -0.9388254042737159, -0.9422223406686382, -0.9455250556146765, -0.9487332188430881, -0.951846509540224, -0.9548646163796085, -0.9577872375530729, -0.9606140808009355, -0.9633448634412269, -0.965979312397959, -0.9685171642284314, -0.9709581651495758, -0.9733020710633344, -0.9755486475810691, -0.9776976700470001, -0.9797489235606718, -0.9817022029984421, -0.9835573130339951, -0.9853140681578729, -0.9869722926960274, -0.9885318208273864, -0.9899924966004364, -0.9913541739488175, -0.9926167167059293, -0.9937799986185485, -0.9948439033594529, -0.9958083245390553, -0.9966731657160413, -0.9974383404070138, -0.9981037720951416, -0.9986693942378102, -0.9991351502732767, -0.9995009936263258, -0.999766887712927, -0.9999328059438931, -0.9999987317275394, -0.9999646584713425, -0.9998305895825996, -0.9995965384680877, -0.9992625285327235, -0.998828593177222, -0.998294775794757, -0.9976611297666222, -0.9969277184568923, -0.996094615206087, -0.9951619033238371, -0.9941296760805537, -0.9929980366981008, -0.9917670983394739, -0.9904369840974827, -0.9890078269824433, -0.987479769908876, -0.9858529656812148, -0.984127576978527, -0.982303776338245, -0.9803817461389128, -0.9783616785819488, -0.9762437756724254, -0.9740282491988684, -0.971715320712079, -0.9693052215029786, -0.9667981925794795, -0.9641944846423849, -0.9614943580603188, -0.9586980828436893, -0.9558059386176879, -0.952818214594327, -0.9497352095435192, -0.9465572317632004, -0.9432845990485004, -0.9399176386599634, -0.9364566872908224, -0.9329020910333304, -0.9292542053441509, -0.9255133950088129, -0.9216800341052326, -0.9177545059663059, -0.9137372031415755, -0.909628527357976, -0.9054288894796619, -0.9011387094669215, -0.8967584163341809, -0.892288448107103, -0.8877292517787856, -0.8830812832650622, -0.878345007358911, -0.8735208976839756, -0.8686094366472035, -0.8636111153906054, -0.8585264337421418, -0.8533559001657404, -0.8481000317104498, -0.8427593539587359, -0.8373344009739233, -0.8318257152467896, -0.826233847641317, -0.8205593573396063, -0.8148028117859587, -0.8089647866301326, -0.8030458656697786, -0.7970466407920603, -0.7909677119144661, -0.784809686924818, -0.7785731816204834, -0.7722588196467954, -0.7658672324346898, -0.7593990591375611, -0.7528549465673492, -0.7462355491298577, -0.7395415287593139, -0.7327735548521768, -0.7259323042001972, -0.719018460922739, -0.7120327163983686, -0.704975769195717, -0.6978483250036237, -0.6906510965605683, -0.6833848035833977, -0.6760501726953541, -0.6686479373534142, -0.6611788377749437, -0.6536436208636762, -0.6460430401350237, -0.638377855640725, -0.630648833892842, -0.6228567477871086, -0.6150023765256422, -0.6070865055390234, -0.5991099264077545, -0.5910734367831014, -0.5829778403073296, -0.5748239465333402, -0.566612570843716, -0.5583445343691829, -0.5500206639064984, -0.5416417918357723, -0.5332087560372293, -0.5247223998074217, -0.5161835717749006, -0.5075931258153535, -0.4989519209662179, -0.4902608213407774, -0.4815206960417522, -0.47273241907438873, -0.46389686925906015, -0.4550149301433852, -0.44608748991387365, -0.4371154413071091, -0.4280996815204755, -0.4190411121224384, -0.4099406389623888, -0.40079917208005905, -0.39161762561451946, -0.3823969177127654, -0.3731379704379031, -0.36384170967694424, -0.3545090650482181, -0.3451409698084104, -0.33573836075923835, -0.32630217815377144, -0.3168333656024067, -0.3073328699785087, -0.29780164132372267, -0.2882406327529715, -0.2786508003591448, -0.26903310311749035, -0.2593885027897177, -0.24971796382782238, -0.24002245327764193, -0.23030294068215176, -0.22056039798451188, -0.21079579943087323, -0.20101012147295408, -0.19120434267039554, -0.18137944359290636, -0.1715364067222069, -0.1616762163537818, -0.151799858498451, -0.14190832078376986, -0.13200259235526687, -0.12208366377753015, -0.11215252693515171, -0.10221017493353989, -0.09225760199960958, -0.0822958033823604, -0.07232577525335257, -0.06234851460709069, -0.05236501916132503, -0.042376287257280605, -0.03238331775982391, -0.02238710995757724, -0.012388663462990671, -0.0023889781123816573, 0.007610946134047786, 0.017610109292206258, 0.027607511454110552, 0.03760215288787562, 0.047593034137686924, 0.05757915612374518, 0.06755952024217354, 0.0775331284648771, 0.08749898343934488, 0.09745608858838432, 0.10740344820977805, 0.11734006757585339, 0.12726495303295418, 0.1371771121008055, 0.14707555357176058, 0.15695928760992103, 0.16682732585011947, 0.17667868149675522, 0.18651236942247304, 0.19632740626667505, 0.20612281053385603, 0.21589760269175207, 0.225650805269293, 0.23538144295434868, 0.24508854269125951, 0.254771133778141, 0.2644282479639532, 0.2740589195453252, 0.2836621854631243, 0.2932370853987615, 0.3027826618702222, 0.31229796032781393, 0.3217820292496203, 0.33123392023665255, 0.34065268810768845, 0.3500373909937899, 0.3593870904324888, 0.36870085146163273, 0.37797774271288015, 0.3872168365048367, 0.3964172089358224, 0.40557793997626107, 0.4146981135606826, 0.4237768176793287, 0.43281314446935304, 0.44180619030560686, 0.4507550558910007, 0.4596588463464334, 0.46851667130027924, 0.4773276449774243, 0.48609088628784336, 0.494805518914708, 0.5034706714020177, 0.5120854772417448, 0.5206490749604841, 0.5291606082056002, 0.5376192258308614, 0.546024081981554, 0.5543743361790671, 0.5626691534049393, 0.5709077041843604, 0.579089164669118, 0.5872127167199813, 0.595277547988515, 0.6032828519983127, 0.6112278282256447, 0.6191116821795088, 0.6269336254810798, 0.6346928759425456, 0.6423886576453262, 0.6500202010176642, 0.6575867429115821, 0.6650875266791961, 0.67252180224838, 0.6798888261977719, 0.6871878618311162, 0.6944181792509321, 0.7015790554315027, 0.7086697742911775, 0.7156896267639793, 0.7226379108705108, 0.7295139317881514, 0.7363170019205395, 0.743046440966331, 0.7497015759872292, 0.7562817414752778, 0.7627862794194117, 0.7692145393712567, 0.7755658785101746, 0.7818396617075443, 0.7880352615902739, 0.7941520586035385, 0.8001894410727339, 0.8061468052646443, 0.8120235554478151, 0.8178191039521251, 0.8235328712275536, 0.8291642859021344, 0.834712784839093, 0.8401778131931592, 0.845558824466052, 0.8508552805611282, 0.8560666518371921, 0.8611924171614587, 0.8662320639616671, 0.871185088277337, 0.8760509948101644, 0.8808292969735507, 0.8855195169412616, 0.890121185695209, 0.894633843072352, 0.8990570378107136, 0.9033903275945057, 0.9076332790983611, 0.9117854680306652, 0.915846479175985, 0.9198159064365901, 0.9236933528730621, 0.9274784307439888, 0.9311707615447372, 0.9347699760453042, 0.938275714327239, 0.9416876258196349, 0.945005369334186, 0.9482286130993055, 0.9513570347933029, 0.954390321576616, 0.9573281701230939, 0.9601702866503303, 0.962916386949041, 0.9655661964114844, 0.9681194500589225, 0.9705758925681183, 0.9729352782968678, 0.9751973713085642, 0.9773619453957916, 0.979428784102945, 0.981397680747876, 0.983268438442561, 0.9850408701127893, 0.9867147985168709, 0.9882900562633605, 0.9897664858277961, 0.9911439395684516, 0.9924222797411006, 0.9936013785127915, 0.9946811179746294, 0.9956613901535681, 0.9965420970232065, 0.9973231505135915, 0.9980044725200251, 0.9985859949108742, 0.9990676595343845, 0.999449418224495, 0.9997312328056548, 0.9999130750966405, 0.9999949269133748, 0.999976780070744, 0.9998586363834174, 0.9996405076656651, 0.9993224157301774, 0.9989043923858825, 0.9983864794347665, 0.9977687286676931, 0.997051201859224, 0.9962339707614424, 0.9953171170967766, 0.9943007325498295, 0.9931849187582086, 0.9919697873023631, 0.9906554596944261, 0.9892420673660632, 0.9877297516553294, 0.9861186637925353, 0.9844089648851249, 0.982600825901564, 0.9806944276542442, 0.9786899607814017, 0.9765876257280532, 0.9743876327259523, 0.9720902017725658, 0.9696955626090745, 0.9672039546973992, 0.9646156271962548, 0.9619308389362344, 0.9591498583939269, 0.9562729636650688, 0.9533004424367356, 0.9502325919585732, 0.9470697190130728, 0.9438121398848932, 0.9404601803292326, 0.9370141755392534, 0.9334744701125627, 0.9298414180167536, 0.926115382554008, 0.9222967363247674, 0.9183858611904723, 0.9143831482353771, 0.9102889977274419, 0.9061038190783055, 0.9018280308023454, 0.8974620604748258, 0.8930063446891413, 0.8884613290131574, 0.8838274679446542, 0.8791052248658768, 0.8742950719971982, 0.8693974903498967, 0.8644129696780556, 0.8593420084295885, 0.8541851136963945, 0.8489428011636493, 0.8436155950582377, 0.838204028096331, 0.8327086414301156, 0.8271299845936788, 0.8214686154480554, 0.815725100125442, 0.8099000129725847, 0.8039939364933447, 0.798007461290448, 0.7919411860064263, 0.7857957172637526, 0.7795716696041802, 0.7732696654272884, 0.766890334928243, 0.7604343160347778, 0.7539022543434025, 0.7472948030548425, 0.7406126229087208, 0.7338563821174832, 0.7270267562995788, 0.720124428411898, 0.7131500886814779, 0.7061044345364793, 0.6989881705364455, 0.6918020083018461, 0.6845466664429165, 0.6772228704877962, 0.6698313528099775, 0.6623728525550688, 0.6548481155668803, 0.6472578943128399, 0.6396029478087479, 0.6318840415428759, 0.6241019473994178, 0.6162574435813031, 0.6083513145323762, 0.600384350858954, 0.5923573492507646, 0.5842711124012794, 0.5761264489274451, 0.5679241732888218, 0.5596651057061383, 0.5513500720792701, 0.542979903904651, 0.534555438192123, 0.5260775173812373, 0.5175469892570099, 0.5089647068651445, 0.5003315284267285, 0.4916483172524113, 0.4829159416560745, 0.47413527486800067, 0.46530719494755146, 0.4564325846953622, 0.4475123315650626, 0.4385473275745322, 0.42953846921669925, 0.42048665736989216, 0.41139279720775246, 0.40225779810871815, 0.39308257356508675, 0.3838680410916665, 0.3746151221340261, 0.3653247419763505, 0.3559978296489135, 0.34663531783517554, 0.3372381427785158, 0.3278072441886091, 0.3183435651474554, 0.3088480520150723, 0.29932165433486024, 0.2897653247386486, 0.2801800188514333, 0.2705666951958155, 0.2609263150961496, 0.25125984258241196, 0.24156824429379858, 0.23185248938206202, 0.22211354941459702, 0.21235239827728455, 0.20257001207710412, 0.19276736904452377, 0.1829454494356779, 0.17310523543434247, 0.1632477110537175, 0.15337386203802647, 0.14348467576394278, 0.13358114114185285, 0.12366424851696596, 0.1137349895702806, 0.10379435721941703, 0.09384334551932655, 0.08388294956288665, 0.0739141653813927, 0.06393798984495554, 0.053955420562815354, 0.04396745578358159, 0.0339750942954089, 0.02397933532611915, 0.013981178443279504, 0.00398162345424647, -0.006018329693813979, -0.016017681013920305, -0.02601543057927326, -0.036010578623247746, -0.04600212563936862, -0.05598907248126053, -0.06597042046256173, -0.07594517145679183, -0.08591232799716368, -0.0958708933763292, -0.10581987174604922, -0.11575826821677757, -0.12568508895714914, -0.13559934129336224, -0.14550003380844506, -0.15538617644139666, -0.16525678058619217, -0.1751108591906426, -0.18494742685509918, -0.1947654999309926, -0.20456409661919694, -0.2143422370682089, -0.224098943472132, -0.23383324016845633, -0.24354415373562424, -0.2532307130903714, -0.2628919495848343, -0.2725268971034147, -0.28213459215938974, -0.2917140739912602, -0.3012643846588258, -0.3107845691389784, -0.3202736754212033, -0.32973075460277995, -0.339154860983671, -0.34854505216109183, -0.3579003891237498, -0.3672199363457447, -0.3765027618801206, -0.3857479374520598, -0.3949545385517093, -0.40412164452663135, -0.4132483386738676, -0.422333708331609, -0.4313768449704608, -0.440376844284295, -0.44933280628068034, -0.4582438353708803, -0.4671090404594118, -0.4759275350331536, -0.48469843724999706, -0.4934208700270295, -0.502093961128242, -0.5107168432517518, -0.5192886541165325, -0.5278085365486406, -0.5362756385669328, -0.5446891134682632, -0.5530481199121529, -0.5613518220049232, -0.5695993893832847, -0.5777899972973723, -0.5859228266932205, -0.5939970642946666, -0.6020119026846791, -0.6099665403860981, -0.6178601819417823, -0.6256920379941541, -0.6334613253641347, -0.6411672671294616, -0.6488090927023799, -0.6563860379067002, -0.6638973450542166, -0.6713422630204734, -0.6787200473198782, -0.6860299601801492, -0.693271270616092, -0.7004432545026972, -0.7075451946475528, -0.7145763808625629, -0.721536110034965, -0.7284236861976416, -0.7352384205987164, -0.7419796317704277, -0.7486466455972763, -0.7552387953834354, -0.7617554219194197, -0.7681958735480061, -0.7745595062293988, -0.7808456836056328, -0.7870537770642086, -0.793183165800954, -0.7992332368821032, -0.8052033853055895, -0.811093014061546, -0.8169015341920048, -0.8226283648497935, -0.8282729333566186, -0.8338346752603331, -0.8393130343913815, -0.8447074629184159, -0.8500174214030791, -0.8552423788539475, -0.8603818127796301, -0.8654352092410171, -0.8704020629026737, -0.8752818770833727, -0.8800741638057624, -0.8847784438451642, -0.8893942467774946, -0.8939211110263064, -0.8983585839089475, -0.9027062216818273, -0.9069635895847917, -0.911130261884598, -0.9152058219174886, -0.9191898621308564, -0.9230819841240001, -0.9268817986879638, -0.9305889258444577, -0.9342029948838553, -0.9377236444022644, -0.9411505223376672, -0.9444832860051255, -0.9477216021310502, -0.9508651468865271, -0.9539136059197004, -0.9568666743872071, -0.9597240569846612, -0.9624854679761844, -0.9651506312229784, -0.9677192802109397, -0.9701911580773099, -0.9725660176363623, -0.9748436214041201, -0.9770237416221045, -0.9791061602801103, -0.9810906691380072, -0.9829770697465632, -0.9847651734672894, -0.9864548014913037, -0.9880457848572118, -0.989537964468003, -0.9909311911069596, -0.9922253254525788, -0.9934202380925043, -0.9945158095364681, -0.9955119302282386, -0.9964085005565768, -0.9972054308651971, -0.9979026414617326, -0.9985000626257046, -0.9989976346154947, -0.9993953076743185, -0.9996930420352015, -0.9998908079249558, -0.9999885855671571, -0.9999863651841228, -0.9998841469978893, -0.9996819412301899, -0.9993797681014331, -0.9989776578286799, -0.9984756506226223, -0.9978737966835628, -0.9971721561963937, -0.996370799324579, -0.995469806203138, -0.9944692669306321, -0.9933692815601548, -0.9921699600893265, -0.9908714224492947, -0.9894737984927415, -0.9879772279808978, -0.9863818605695676, -0.9846878557941625, -0.9828953830537486, -0.9810046215941061, -0.9790157604898052, -0.9769289986252991, -0.9747445446750352, -0.9724626170825884, -0.9700834440388161, -0.96760726345904, -0.9650343229592547, -0.9623648798313662, -0.9595992010174625, -0.9567375630831204, -0.9537802521897487, -0.9507275640659723, -0.9475798039780595, -0.9443372866993962, -0.941000336479008, -0.9375692870091363, -0.9340444813918688, -0.93042627210483, -0.9267150209659333, -0.9229110990971999, -0.9190148868876469, -0.9150267739552482, -0.9109471591079739, -0.9067764503039089, -0.9025150646104579, -0.8981634281626394, -0.8937219761204716, -0.8891911526254574, -0.8845714107561711, -0.8798632124829494, -0.8750670286216964, -0.8701833387868013, -0.8652126313431779, -0.8601554033574282, -0.8550121605481367, -0.849783417235298, -0.8444696962888865, -0.8390715290765682, -0.8335894554105664, -0.8280240234936791, -0.8223757898644601, -0.8166453193415656, -0.8108331849672723, -0.8049399679501745, -0.7989662576070626, -0.7929126513039931, -0.7867797543965516, -0.780568180169318, -0.7742785497745387, -0.7679114921700121, -0.7614676440561924, -0.7549476498125215, -0.7483521614329902, -0.7416818384609404, -0.7349373479231106, -0.7281193642629343, -0.7212285692730958, -0.7142656520273517, -0.7072313088116243, -0.7001262430543733, -0.6929511652562534, -0.6857067929190652, -0.6783938504740056, -0.6710130692092249, -0.663565187196699, -0.6560509492184226, -0.6484711066919315, -0.6408264175951622, -0.6331176463906535, -0.6253455639491021, -0.6175109474722753, -0.609614580415292, -0.6016572524082777, -0.5936397591774019, -0.5855629024653065, -0.5774274899509321, -0.5692343351687504, -0.5609842574274124, -0.5526780817278169, -0.5443166386806122, -0.5359007644231351, -0.5274313005357981, -0.5189090939579322, -0.5103349969030933, -0.5017098667738419, -0.49303456607600316, -0.4843099623324177, -0.4755369279961892, -0.4667163403634406, -0.4578490814855846, -0.4489360380811197, -0.4399781014469588, -0.43097616736930044, -0.42193113603405075, -0.41284391193680575, -0.4037154037924025, -0.3945465244440484, -0.3853381907720376, -0.37609132360206365, -0.3668068476131379, -0.3574856912451222, -0.34812878660588575, -0.33873706937809506, -0.3293114787256465, -0.3198529571997507, -0.31036245064467816, -0.30084090810317565, -0.2912892817215628, -0.281708526654518, -0.2720996009695641, -0.26246346555126215, -0.2528010840051239, -0.24311342256125204, -0.23340144997771786, -0.22366613744368646, -0.21390845848229856, -0.20412938885331885, -0.19432990645556109, -0.1845109912290988, -0.17467362505727227, -0.16481879166850086, -0.15494747653791116, -0.14506066678879012, -0.1351593510938737, -0.12524451957648028, -0.11531716371149933, -0.10537827622624453, -0.09542885100118205, -0.08546988297054324, -0.07550236802283203, -0.06552730290123696, -0.05554568510395768, -0.04555851278445592, -0.035566784651641016, -0.025571499869999834, -0.015573657959681164, -0.0055742586965445325, 0.0044256979878165535, 0.014425212106066928, 0.024423283715127666, 0.03441891301616956, 0.044411100454592164, 0.05439884681997844, 0.06438115334601494, 0.07435702181036763, 0.08432545463450325, 0.0942854549834464, 0.10423602686546216, 0.11417617523165444, 0.12410490607547003, 0.1340212265320985, 0.14392414497775777, 0.1538126711288556, 0.16368581614101738, 0.17354259270796946, 0.18338201516026906, 0.1932030995638705, 0.20300486381851757, 0.21278632775595296, 0.2225465132379341, 0.23228444425404626, 0.24199914701930272, 0.25168965007152255, 0.26135498436847593, 0.27099418338478753, 0.2806062832085884, 0.2901903226379062, 0.29974534327678465, 0.3092703896311224, 0.3187645092042215, 0.3282267525920364, 0.33765617357811345, 0.3470518292282119, 0.3564127799845965, 0.36573808975999217, 0.37502682603119264, 0.38427805993231134, 0.3934908663476674, 0.4026643240042967, 0.411797515564078, 0.4208895277154664, 0.4299394512648233, 0.4389463812273355, 0.4479094169175123, 0.456827662039254, 0.46570022477548023, 0.47452621787731114, 0.4833047587527915, 0.4920349695551492, 0.5007159772705791, 0.509346913805544, 0.5179269160735827, 0.5264551260816183, 0.5349306910157569, 0.543352763326568, 0.5517205008138389, 0.560033066710794, 0.5682896297677706, 0.5764893643353437, 0.5846314504468894, 0.5927150739005815, 0.6007394263408113, 0.6087037053390216, 0.6166071144739493, 0.6244488634112672, 0.6322281679826163, 0.639944250264022, 0.6475963386536866, 0.6551836679491476, 0.6627054794237983, 0.6701610209027593, 0.6775495468380957, 0.684870318383371, 0.6921226034675314, 0.6993056768681118, 0.7064188202837584, 0.7134613224060569, 0.720432478990664, 0.7273315929277303, 0.7341579743116116, 0.740910940509858, 0.7475898162314769, 0.7541939335944624, 0.7607226321925812, 0.767175259161414, 0.7735511692436415, 0.7798497248535684, 0.7860702961408825, 0.7922122610536388, 0.7982750054004647, 0.8042579229119773, 0.8101604153014115, 0.815981892324447, 0.8217217718382326, 0.8273794798596003, 0.8329544506224626, 0.8384461266343891, 0.843853958732355, 0.8491774061376569, 0.8544159365099905, 0.859569026000684, 0.8646361593050826, 0.8696168297140785, 0.8745105391647812, 0.8793167982903237, 0.8840351264687988, 0.8886650518713205, 0.8932061115092068, 0.8976578512802782, 0.9020198260142672, 0.9062915995173355, 0.9104727446156926, 0.9145628431983128, 0.9185614862587463, 0.9224682739360195, 0.9262828155546199, 0.9300047296635647, 0.9336336440745445, 0.9371691958991423, 0.9406110315851218, 0.9439588069517828, 0.9472121872243784, 0.9503708470675923, 0.9534344706180726, 0.9564027515160172, 0.9592753929358098, 0.9620521076157023, 0.9647326178865406, 0.9673166556995315, 0.969803962653047, 0.9721942900184644, 0.9744873987650392, 0.9766830595838076, 0.9787810529105175, 0.9807811689475845, 0.9826832076850717, 0.9844869789206903, 0.9861923022788198, 0.9877990072285457, 0.9893069331007119, 0.9907159291039878, 0.9920258543399469, 0.9932365778171577, 0.994347978464281, 0.9953599451421786, 0.9962723766550258, 0.9970851817604316, 0.997798279178563, 0.9984115976002723, 0.9989250756942285, 0.9993386621130501, 0.9996523154984398, 0.9998660044853205, 0.9999797077049716};
constexpr double precomputed_asin[] = { -1.5707963267948966,-1.4292568534704695,-1.370461484471777,-1.3252308092796046,-1.2870022175865685,-1.253235897503375,-1.2226303055219356,-1.1944128444771682,-1.1680804852142348,-1.1432840618500268,-1.119769514998634,-1.0973451695228302,-1.0758622004540008,-1.055202320548806,-1.0352696724805086,-1.0159852938148248,-0.9972832223717996,-0.9791076843683524,-0.9614110187641013,-0.9441521151541556,-0.927295218001612,-0.9108089974073978,-0.8946658172342349,-0.8788411516685793,-0.8633131150155533,-0.8480620789814807,-0.8330703583416474,-0.8183219506315594,-0.8038023189330297,-0.7894982093461717,-0.7753974966107526,-0.7614890527476328,-0.7477626346599202,-0.7342087874533585,-0.7208187608700892,-0.7075844367253552,-0.6944982656265556,-0.6815532115631164,-0.6687427032023713,-0.6560605909249222,-0.6435011087932839,-0.6310588407780209,-0.6187286906722507,-0.6065058552130864,-0.5943858000010618,-0.582364237868743,-0.5704371093999214,-0.5586005653428002,-0.5468509506959436,-0.5351847902755993,-0.5235987755982984,-0.5120897529341473,-0.5006547124045876,-0.4892907780141152,-0.47799519851895184,-0.46676533904729584,-0.45559867339582283,-0.44449277693581846,-0.4334453200698854,-0.4224540621867552,-0.41151684606748745,-0.40063159270137133,-0.38979629647425995,-0.3790090206959502,-0.36826789343663935,-0.35757110364550965,-0.3469168975271611,-0.33630357515397974,-0.3257294872946295,-0.3151930324407238,-0.30469265401539686,-0.29422683774898184,-0.2837941092083272,-0.27339303146747257,-0.26302220290846823,-0.252680255142078,-0.24236585103896255,-0.23207768286271246,-0.2218144704967937,-0.2115749597580949,-0.20135792079033007,-0.19116214653105887,-0.18098645124654697,-0.17082966912910375,-0.16069065295190985,-0.15056827277668527,-0.14046141470985504,-0.13036897970314473,-0.12028988239478729,-0.11022304998774583,-0.100167421161559,-0.09012194501459445,-0.08008558003365819,-0.07005729308804942,-0.06003605844527759,-0.05002085680576917,-0.04001067435398807,-0.030004501823476075,-0.02000133357338962,-0.010000166674166235,8.881784197001252e-16,0.010000166674168011,0.020001333573391396,0.03000450182347785,0.04001067435398985,0.050020856805770945,0.060036058445279365,0.07005729308805121,0.08008558003365998,0.09012194501459622,0.10016742116156079,0.11022304998774762,0.12028988239478908,0.13036897970314654,0.14046141470985682,0.15056827277668705,0.16069065295191165,0.17082966912910555,0.18098645124654877,0.19116214653106067,0.20135792079033188,0.2115749597580967,0.22181447049679553,0.2320776828627143,0.24236585103896438,0.2526802551420798,0.26302220290847006,0.2733930314674744,0.28379410920832904,0.29422683774898367,0.30469265401539875,0.31519303244072566,0.3257294872946314,0.33630357515398157,0.346916897527163,0.3575711036455116,0.3682678934366413,0.3790090206959521,0.3897962964742619,0.4006315927013733,0.4115168460674894,0.42245406218675713,0.43344532006988734,0.44449277693582046,0.45559867339582477,0.4667653390472978,0.47799519851895383,0.4892907780141172,0.5006547124045897,0.5120897529341493,0.5235987755983005,0.5351847902756014,0.5468509506959457,0.5586005653428023,0.5704371093999235,0.582364237868745,0.5943858000010639,0.6065058552130886,0.6187286906722528,0.6310588407780231,0.6435011087932861,0.6560605909249244,0.6687427032023736,0.6815532115631188,0.6944982656265579,0.7075844367253575,0.7208187608700916,0.7342087874533609,0.7477626346599227,0.7614890527476353,0.7753974966107552,0.7894982093461741,0.8038023189330322,0.8183219506315621,0.8330703583416501,0.8480620789814833,0.8633131150155561,0.8788411516685821,0.8946658172342378,0.9108089974074007,0.927295218001615,0.9441521151541588,0.9614110187641044,0.9791076843683556,0.9972832223718029,1.0159852938148282,1.0352696724805122,1.0552023205488095,1.0758622004540046,1.097345169522834,1.1197695149986382,1.143284061850031,1.1680804852142395,1.194412844477173,1.2226303055219407,1.2532358975033808,1.287002217586575,1.3252308092796117,1.370461484471786,1.429256853470482 };
constexpr double precomputed_acos[] = { 3.141592653589793,3.000053180265366,2.9412578112666736,2.896027136074501,2.857798544381465,2.824032224298272,2.793426632316832,2.765209171272065,2.7388768120091314,2.7140803886449234,2.6905658417935308,2.668141496317727,2.6466585272488974,2.6259986473437023,2.606065999275405,2.5867816206097216,2.568079549166696,2.5499040111632487,2.532207345558998,2.5149484419490524,2.498091544796509,2.4816053242022944,2.4654621440291313,2.449637478463476,2.43410944181045,2.418858405776377,2.4038666851365442,2.389118277426456,2.3745986457279264,2.360294536141068,2.3461938234056494,2.3322853795425296,2.3185589614548165,2.3050051142482553,2.2916150876649857,2.2783807635202518,2.2652945924214523,2.252349538358013,2.239539029997268,2.226856917719819,2.2142974355881804,2.2018551675729174,2.1895250174671474,2.177302182007983,2.1651821267959583,2.1531605646636396,2.1412334361948178,2.129396892137697,2.1176472774908404,2.105981117070496,2.094395102393195,2.082886079729044,2.0714510391994843,2.060087104809012,2.0487915253138484,2.0375616658421922,2.0263950001907194,2.0152891037307152,2.004241646864782,1.9932503889816517,1.982313172862384,1.9714279194962678,1.9605926232691566,1.9498053474908468,1.939064220231536,1.9283674304404064,1.9177132243220578,1.9070999019488764,1.896525814089526,1.8859893592356205,1.8754889808102935,1.8650231645438784,1.8545904360032237,1.8441893582623692,1.833818529703365,1.8234765819369745,1.8131621778338591,1.802874009657609,1.7926107972916903,1.7823712865529915,1.7721542475852268,1.7619584733259555,1.7517827780414437,1.7416259959240004,1.7314869797468064,1.7213645995715818,1.7112577415047516,1.7011653064980414,1.6910862091896839,1.6810193767826425,1.6709637479564556,1.660918271809491,1.6508819068285547,1.640853619882946,1.6308323852401743,1.6208171836006657,1.6108070011488846,1.6008008286183726,1.5907976603682863,1.5807964934690628,1.5707963267948957,1.5607961601207285,1.5507949932215053,1.5407918249714188,1.5307856524409067,1.5207754699891256,1.5107602683496173,1.5007390337068454,1.4907107467612366,1.4806743817803003,1.470628905633336,1.4605732768071489,1.4505064444001075,1.4404273470917501,1.4303349120850397,1.4202280540182095,1.410105673842985,1.399966657665791,1.389809875548348,1.3796341802638359,1.3694384060045648,1.3592213670367999,1.348981856298101,1.3387186439321823,1.3284304757559322,1.3181160716528169,1.3077741238864267,1.2974032953274222,1.2870022175865676,1.276569489045913,1.2661036727794979,1.255603294354171,1.2450668395002653,1.234492751640915,1.2238794292677335,1.2132252231493852,1.2025284333582553,1.1917873060989446,1.1810000303206347,1.1701647340935233,1.1592794807274072,1.1483422646081394,1.1373510067250092,1.126303549859076,1.115197653399072,1.104030987747599,1.092801128275943,1.0815055487807794,1.070141614390307,1.0587065738607473,1.0471975511965963,1.0356115365192953,1.023945376098951,1.0121957614520942,1.0003592173949731,0.9884320889261515,0.9764105267938328,0.9642904715818079,0.9520676361226438,0.9397374860168735,0.9272952180016104,0.9147357358699721,0.9020536235925231,0.8892431152317778,0.8762980611683387,0.8632118900695391,0.849977565924805,0.8365875393415357,0.823033692134974,0.8093072740472613,0.7953988301841415,0.7812981174487225,0.7669940078618643,0.7524743761633346,0.7377259684532466,0.7227342478134132,0.7074832117793406,0.6919551751263144,0.6761305095606589,0.6599873293874958,0.6435011087932817,0.6266442116407379,0.6093853080307922,0.5916886424265411,0.5735131044230938,0.5548110329800684,0.5355266543143846,0.5155940062460871,0.494934126340892,0.47345115727206255,0.4510268117962586,0.4275122649448655,0.4027158415806572,0.37638348231772356,0.3481660212729558,0.3175604292915158,0.28379410920832165,0.2455655175152848,0.20033484232311075,0.1415394733244147 };
TVoxelSharedRef<FVoxelGeneratorInstance> UMyVoxelPlanetGenerator::GetInstance()
{
	return MakeVoxelShared<FMyVoxelPlanetGeneratorInstance>(*this);
}

FMyVoxelPlanetGeneratorInstance::FMyVoxelPlanetGeneratorInstance(UMyVoxelPlanetGenerator& MyGenerator)
	: Super(&MyGenerator)
	, NoiseHeight(MyGenerator.NoiseHeight)
	, Seed(MyGenerator.Seed)
	, Radius(MyGenerator.Radius)
	, PlanetTopography(MyGenerator.PlanetTopography)
	, gX(MyGenerator.gX), gY(MyGenerator.gY)
	, gbX(MyGenerator.gbX), gbY(MyGenerator.gbY)
	, FormatedTopographyImageData(MyGenerator.FormatedTopographyImageData)
	, FormatedBiomesImageData(MyGenerator.FormatedBiomesImageData)
	, HeightMultiplier(MyGenerator.HeightMultiplier)
	, Epsilon(MyGenerator.Epsilon)
	, SmoothingMethod(MyGenerator.SmoothingMethod)
	, Epsilons(MyGenerator.Epsilons)
	, SmoothSize(MyGenerator.SmoothSize)
	, isServer(MyGenerator.isServer)
{
}

void FMyVoxelPlanetGeneratorInstance::Init(const FVoxelGeneratorInit& InitStruct)
{
	noise.SetNoiseType(FastNoiseLite::NoiseType_OpenSimplex2);
	Noise.SetSeed(Seed);
}

namespace {
	FVector GetStableRandomSphereTangent(
		const FVector& SphereCenter,
		const FVector& PointOnSphere,
		int32 Seed = 1337
	)
	{
		FVector Normal = (PointOnSphere - SphereCenter).GetSafeNormal();

		int32 Hash = HashCombine(
			GetTypeHash(PointOnSphere.X),
			HashCombine(
				GetTypeHash(PointOnSphere.Y),
				GetTypeHash(PointOnSphere.Z)
			)
		);

		FRandomStream Stream(Hash + Seed);

		FVector Tangent;
		do
		{
			FVector RandomVector = Stream.VRand();
			Tangent = RandomVector - FVector::DotProduct(RandomVector, Normal) * Normal;
		} while (Tangent.SizeSquared() < KINDA_SMALL_NUMBER);

		return Tangent.GetSafeNormal();
	}

	FVector GetRandomVector(const FVector position) {
		int32 Hash = HashCombine(
			GetTypeHash(position.X),
			HashCombine(
				GetTypeHash(position.Y),
				GetTypeHash(position.Z)
			)
		);
		FRandomStream Stream(Hash);
		return Stream.VRand();
	}
}

v_flt FMyVoxelPlanetGeneratorInstance::GetValueImpl(v_flt X, v_flt Y, v_flt Z, int32 LOD, const FVoxelItemStack& Items) const
{
	// Normalize the position to get the 3D noise sample position
	const FVector SamplePosition = FVector(X, Y, Z);
	double Value = 0;
	if (isServer) return Value;
	auto e = Seed;
	float Height = Radius;
	float value = 0;
	float Pi = 3.14159265359;
	int smoothSize = SmoothSize;
	auto RidgedMultifractal = [this, &SamplePosition]() {
		// float A, freq, H, lacunarity, octaves;
		/* get first octave */
		float signal;
		float offset = 1;
		float gain = 1;
		float frequency = Epsilons[2], Amp = Epsilons[1];
		signal = noise.GetNoise((float)SamplePosition.X, (float)SamplePosition.Y, (float)SamplePosition.Z);;

		/* get absolute value of signal (this creates the ridges) */
		if (signal < 0.0) signal = -1 * signal;

		/* invert and translate (note that "offset" should be ~= 1.0) */
		signal = offset - signal;
		/* square the signal, to increase "sharpness" of ridges */
		signal *= signal;
		/* assign initial values */
		float result = signal;
		float weight = 0.5;
		float lacunarity = Epsilons[4];
		FVector point = SamplePosition;
		//return result;
		for (int i = 1; i < Epsilons[3]; i++) {

			/* increase the frequency */
			point.X *= lacunarity;
			point.Y *= lacunarity;
			point.Z *= lacunarity;
			Amp		/= lacunarity;

			/* weight successive contributions by previous signal */
			weight = signal * gain;
			if (weight > 1.0) weight = 1.0;
			if (weight < 0.0) weight = 0.0;
			signal = noise.GetNoise((float)point.X, (float)point.Y, (float)point.Z); //(snoise(point));
			if (signal < 0.0) signal = -signal;
			signal = offset - signal;
			signal *= signal;
			/* weight the contribution */
			signal *= weight;
			result += signal *Amp;
		}
		return( result);
		};
	auto fbm = [this, &SamplePosition]()
		{
			float value = 0.0f;
			int i = 0;
			float freq = Epsilons[2];
			float A = Epsilons[1];
			float H = Epsilons[5];
			float lacunarity = Epsilons[4];
			FVector seed = SamplePosition;
			for (i; i < Epsilons[3]; i++)
			{
				value += A * noise.GetNoise((float)seed.X * freq, (float)seed.Y * freq, (float)seed.Z * freq);
				freq *= lacunarity;
				A /= lacunarity;
			}
			return value;
		};
	auto constfbm = [this, &SamplePosition]()
		{
			float value = 0.0f;
			int i = 0;
			float freq = 4.5;
			float A = 0.5;
			float H = 0.55;
			float lacunarity = 2;
			FVector seed = SamplePosition;
			for (i; i < 4; i++)
			{
				value += A * noise.GetNoise((float)seed.X * freq, (float)seed.Y * freq, (float)seed.Z * freq);
				freq *= lacunarity;
				A /= lacunarity;
			}
			return value;
		};
	//float noiseVal = constfbm();
	if (Epsilons.Num() >= 5) {
		//Height += getTopographyAt(generateUV(SamplePosition + GetRandomVector(SamplePosition) * Epsilon))* HeightMultiplier + RidgedMultifractal();// +constfbm();// +noiseVal;
	}
	else {
		//Height += getTopographyAt(generateUV(SamplePosition+ GetRandomVector(SamplePosition)*Epsilon)) * HeightMultiplier;// +constfbm();
	}
	Height += getTopographyAt(generateUV(SamplePosition)) * HeightMultiplier;
	Value = FVector(X, Y, Z).Size() - Height;

	Value /= 500.0;
	
	return Value;
}

FVoxelMaterial FMyVoxelPlanetGeneratorInstance::GetMaterialImpl(v_flt X, v_flt Y, v_flt Z, int32 LOD, const FVoxelItemStack& Items) const
{
	FVoxelMaterialBuilder Builder;
	Builder.SetMaterialConfig(EVoxelMaterialConfig::RGB);
	
	
	return Builder.Build();
}

TVoxelRange<v_flt> FMyVoxelPlanetGeneratorInstance::GetValueRangeImpl(const FVoxelIntBox& Bounds, int32 LOD, const FVoxelItemStack& Items) const
{
	// Return the values that GetValueImpl can return in Bounds
	// Used to skip chunks where the value does not change
	// Be careful, if wrong your world will have holes!
	// By default return infinite range to be safe
	return TVoxelRange<v_flt>::Infinite();

	// Example for the GetValueImpl above

	// Noise is between -1 and 1
	const TVoxelRange<v_flt> Height = TVoxelRange<v_flt>(-1, 1);

	// Z can go from min to max
	TVoxelRange<v_flt> Value = TVoxelRange<v_flt>(Bounds.Min.Z, Bounds.Max.Z) - Height;

	Value /= 50;

	return Value;
}

FVector FMyVoxelPlanetGeneratorInstance::GetUpVector(v_flt X, v_flt Y, v_flt Z) const
{
	// Used by spawners
	return FVector::UpVector;
}


float FMyVoxelPlanetGeneratorInstance::getTopographyAt(FVector2D uv ) const {
	auto fract = [](double n) {
		double temp;
		return modf(n, &temp);
		};
	auto texture = [this](int X, int Y) {

		if (X > (gX - 1)) X = 0;
		//if (Y >= (gY - 11)) return -1.0f;
		if (X < 0) X = gX - 1;
		//if (Y <= 10) return -1.0f;
		return float(FormatedTopographyImageData[X * gY + Y]);

		};
	// Bilinear texture sampling function

	auto sampleData = [this, &texture](FVector2D __uv) {
		auto W_function = [](auto X, auto Y) {
			return X * X * Y * Y * (9 - 6 *
				X - 6 * Y + 4 * X * Y);
			};
		auto W_function_simple = [](auto X, auto Y) {
			return X * Y;
			};
		double X = __uv.X * double(gX);
		double Y = __uv.Y * double(gY);
		if (Epsilons.Num() >= 3) {
			if (Y < Epsilons[1]) return double(Epsilons[2]);
		}

		if (Epsilons.Num() >= 5) {
			if (Y > gY - Epsilons[3]) return double(Epsilons[4]);
		}
		double PixelColor = 0, PixelColor1 = 0, PixelColor2 = 0, PixelColor3 = 0;
		PixelColor = texture(int(X), int(Y));
		PixelColor1 = texture((int(X) + 1), int(Y) + 1);
		PixelColor2 = texture(int(X), int(Y) + 1);
		PixelColor3 = texture((int(X) + 1), int(Y));
		//if (PixelColor == -1.0 || PixelColor1 == -1.0 || PixelColor2 == -1.0 || PixelColor3 == -1.0) return -1.0;


		double temp;
		double FinalColor1 =
			W_function_simple((1 - modf(X, &temp)), (1 - modf(Y, &temp))) * PixelColor +
			W_function_simple(modf(X, &temp), (1 - modf(Y, &temp))) * PixelColor3 +
			W_function_simple((1 - modf(X, &temp)), modf(Y, &temp)) * PixelColor2 +
			W_function_simple(modf(X, &temp), modf(Y, &temp)) * PixelColor1;

		return FinalColor1;
		};

	return (sampleData(uv));
	//return texture(uv.X * double(gX), uv.Y * double(gY));
}; 

float FMyVoxelPlanetGeneratorInstance::getBiomeAt(FVector2D uv) const {
	return 0.0f;
};

FVector FMyVoxelPlanetGeneratorInstance::FindTangentAtPoint(FVector position, float thetaOffset, float phiOffset)const {
	auto FastArcTan2 = [](double y, double x) {
		constexpr double M_PI = 3.141592653589793;
		constexpr double M_PI_2 = 1.5707963267948966;
		constexpr double M_PI_4 = 0.7853981633974483;
		auto FastArcTan = [&M_PI_4](double x) {
			return M_PI_4 * x - x * (fabs(x) - 1) * (0.2447 + 0.0663 * fabs(x));
		};
		if (x >= 0) { // -pi/2 .. pi/2
			if (y >= 0) { // 0 .. pi/2
				if (y < x) { // 0 .. pi/4
					return FastArcTan(y / x);
				}
				else { // pi/4 .. pi/2
					return M_PI_2 - FastArcTan(x / y);
				}
			}
			else {
				if (-y < x) { // -pi/4 .. 0
					return FastArcTan(y / x);
				}
				else { // -pi/2 .. -pi/4
					return -M_PI_2 - FastArcTan(x / y);
				}
			}
		}
		else { // -pi..-pi/2, pi/2..pi
			if (y >= 0) { // pi/2 .. pi
				if (y < -x) { // pi*3/4 .. pi
					return FastArcTan(y / x) + M_PI;
				}
				else { // pi/2 .. pi*3/4
					return M_PI_2 - FastArcTan(x / y);
				}
			}
			else { // -pi .. -pi/2
				if (-y < -x) { // -pi .. -pi*3/4
					return FastArcTan(y / x) - M_PI;
				}
				else { // -pi*3/4 .. -pi/2
					return -M_PI_2 - FastArcTan(x / y);
				}
			}
		}
	};
	auto round = [](float var)
	{
		float value = (int)(var * 100 + .5);
		return (int)value;
	};
	float r = sqrt(position.X * position.X + position.Y * position.Y + position.Z * position.Z);
	if (r == 0) return FVector(0.0);
	float theta = std::acos(position.Z / r); //
	//float theta = precomputed_acos[round(position.Z / r)+100];
	float phi = FastArcTan2(position.Y, position.X);
	round(theta);
	theta += thetaOffset;	//0 -pi
	phi += phiOffset;		//+- pi + pi/2
	FVector tangent = FVector(sin(theta) * cos(phi), sin(theta) * sin(phi), cos(theta));

	if (isnan(tangent.X)) {
		return FVector(0.0);
	}
	return tangent;
}

FVector2D FMyVoxelPlanetGeneratorInstance::generateUV(FVector pos)const {
	double _pi = 3.141592653589793;
	auto round = [](float var)
	{
		float value = (int)(var * 100 + .5);
		return (int)value;
	};
	auto fast_atan2 = [&_pi](double y, double x) {
		static const double pi_2 = _pi / 2;

		double angle;
		double abs_y = std::abs(y) + 1e-10;  // prevent division by zero
		if (x < 0) {
			double r = (x + abs_y) / (abs_y - x);
			angle = pi_2 * (2 - r);
		}
		else {
			double r = (x - abs_y) / (x + abs_y);
			angle = pi_2 * r;
		}

		if (y < 0) {
			angle = -angle;
		}

		return angle;
	};
	auto FastArcTan2 = [](double y, double x) {
		constexpr double M_PI = 3.141592653589793;
		constexpr double M_PI_2 = 1.5707963267948966;
		constexpr double M_PI_4 = 0.7853981633974483;
		auto FastArcTan = [&M_PI_4](double x) {
			return M_PI_4 * x - x * (fabs(x) - 1) * (0.2447 + 0.0663 * fabs(x));
		};
		if (x >= 0) { // -pi/2 .. pi/2
			if (y >= 0) { // 0 .. pi/2
				if (y < x) { // 0 .. pi/4
					return FastArcTan(y / x);
				}
				else { // pi/4 .. pi/2
					return M_PI_2 - FastArcTan(x / y);
				}
			}
			else {
				if (-y < x) { // -pi/4 .. 0
					return FastArcTan(y / x);
				}
				else { // -pi/2 .. -pi/4
					return -M_PI_2 - FastArcTan(x / y);
				}
			}
		}
		else { // -pi..-pi/2, pi/2..pi
			if (y >= 0) { // pi/2 .. pi
				if (y < -x) { // pi*3/4 .. pi
					return FastArcTan(y / x) + M_PI;
				}
				else { // pi/2 .. pi*3/4
					return M_PI_2 - FastArcTan(x / y);
				}
			}
			else { // -pi .. -pi/2
				if (-y < -x) { // -pi .. -pi*3/4
					return FastArcTan(y / x) - M_PI;
				}
				else { // -pi*3/4 .. -pi/2
					return -M_PI_2 - FastArcTan(x / y);
				}
			}
		}
	};
	FVector n = pos;
	n.Normalize(0.0);
	double u = (FastArcTan2(n.X, n.Z) / (2.0 * _pi)) + 0.5;
	double v = 0.5 - (asin(n.Y) / _pi);
	return FVector2D(u, v);
};

void UMyVoxelPlanetGenerator::ReloadPlanetTopography()
{
	if (FormatedTopographyImageData) {
		delete[] FormatedTopographyImageData;
		FormatedTopographyImageData = nullptr;
	}
	if (StaticFormatedTopographyImageData) {
		delete[] StaticFormatedTopographyImageData;
		StaticFormatedTopographyImageData = nullptr;
	}
	dataPopulated = false;
	SetPlanetTopography();
}

void UMyVoxelPlanetGenerator::SetPlanetTopography() {
	UE_LOG(LogTemp, Log, TEXT("LOADING PLANET TOPOGRAPHY"));
	std::string mediumMap = "C:\\Users\\Kedriik\\Documents\\Unreal Projects\\DataTextures\\imagedata\\5672_mars_12k_topo_medium_scaled.txt";
	std::string mediumCustomMap = "C:\\Users\\Kedriik\\Documents\\Unreal Projects\\DataTextures\\imagedata\\5672_mars_12k_topo_medium_scalled_smooth_wrap.txt";
	std::string upMediumCustomMap = "C:\\Users\\Kedriik\\Documents\\Unreal Projects\\DataTextures\\imagedata\\denoised.txt";
	std::string smallMap = "C:\\Users\\Kedriik\\Documents\\Unreal Projects\\DataTextures\\imagedata\\5672_mars_12k_topo_small_scaled.txt";
	std::string smallAliasedMap = "C:\\Users\\Kedriik\\Documents\\Unreal Projects\\DataTextures\\imagedata\\5672_mars_12k_topo_small_scaled_aliased.txt";
	std::string bigMap = "C:\\Users\\Kedriik\\Documents\\Unreal Projects\\DataTextures\\imagedata\\5672_mars_12k_topo_big_scaled.txt";
	std::string bigMap1 = "C:\\Users\\Kedriik\\Documents\\Unreal Projects\\DataTextures\\imagedata\\5672_mars_12k_topo_big_bilinear_scaled.txt";//5672_mars_12k_topo_big_bilinear_scaled.txt
	std::string meidumMapReversed = "C:\\Users\\Kedriik\\Documents\\Unreal Projects\\DataTextures\\imagedata\\5672_mars_12k_topo_medium_scaled_reversed.txt.txt";
	std::string mediumMapReversedNoAntialiasNoSMooth = "C:\\Users\\Kedriik\\Documents\\Unreal Projects\\DataTextures\\imagedata\\5672_mars_12k_topo_medium_scaled_reversed_no_smooth_no_antialias.txt";
	std::string topographyPath = upMediumCustomMap;
	std::string biomesPath = "C:\\Users\\Kedriik\\Documents\\Unreal Projects\\DataTextures\\imagedata\\biomes_denoised.txt";

	auto loadData = [](int** data,int** static_data, std::string backup_path, int& dimX, int& dimY, int& sdimX, int& sdimY) {
		bool useStatic = true;
		if (!useStatic) {
			std::ifstream file(backup_path);
			if (file.is_open()) {
				UE_LOG(LogTemp, Log, TEXT("LOADING NOT FROM RESOURCE"));
				std::string line;
				std::getline(file, line);
				dimX = std::stoi(line);
				std::getline(file, line);
				dimY = std::stoi(line);
				int n = dimX * dimY;
				if (*data == nullptr) {
					*data = new int[n];
				}

				for (int i = 0; i < (dimX) * (dimY); i++) {
					std::getline(file, line);
					*data[i] = std::stoi(line);
				}
				file.close();
			}
		}
		else {
			if (dataPopulated) {
				if (*data == nullptr) {
					*data = new int[dimX * dimY];
				}

				std::memcpy(*data, *static_data, dimX * dimY * sizeof(int));
				return;
			}
			auto GetCurrentDirectory = []()
			{
				char buffer[255];
				GetModuleFileNameA(NULL, buffer, 255);
				std::string::size_type pos = std::string(buffer).find_last_of("\\/");
				return std::string(buffer).substr(0, pos);
			};
			std::string path = GetCurrentDirectory() + "\\map.dat";
			std::ifstream file(path);
			if (!file.is_open()) {
				std::string msg = "LOADING from map.dat failed, path was:" + path;
				FString layerName(msg.c_str());
				UE_LOG(LogTemp, Warning, TEXT("%s"), *layerName);
				file.open(backup_path);
			}
			if (file.is_open()) {
				std::string line;
				std::getline(file, line);
				sdimX = std::stoi(line);
				std::getline(file, line);
				sdimY = std::stoi(line);
				int n = sdimX * sdimY;
				if (*static_data == nullptr) {
					*static_data = new int[n];
				}
				for (int i = 0; i < (sdimX) * (sdimY); i++) {
					std::getline(file, line);
					*(*static_data+i) = std::stoi(line);
				}
				file.close();
				dimX = sdimX;
				dimY = sdimY;
				*data = new int[dimX * dimY];
				std::memcpy(*data, *static_data, dimX * dimY * sizeof(int));
				
			}
		}
	};

	auto ld1 = std::async(std::launch::async, [&loadData,this, &topographyPath](){
		loadData(&FormatedTopographyImageData, &StaticFormatedTopographyImageData, topographyPath, gX, gY, gsX, gsY);
		});
	
	ld1.get();
	dataPopulated = true;
}